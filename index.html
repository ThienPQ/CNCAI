<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò chuyện với CNCAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.102/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #chatbox::-webkit-scrollbar { width: 8px; }
        #chatbox::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chatbox::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chatbox::-webkit-scrollbar-thumb:hover { background: #555; }
        .user-message { background-color: #3b82f6; color: white; }
        .gemini-message { background-color: #ffffff; color: #1f2937; border: 1px solid #e5e7eb; }
        .system-message { font-style: italic; color: #6b7280; text-align: center; font-size: 0.875rem; }
        .message-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 0.75rem; margin-bottom: 0.5rem; word-wrap: break-word; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <!-- SCRIPT BẢO VỆ MÃ NGUỒN (CHẠY SỚM) -->
    <script>
        // Lưu ý: Các biện pháp này chỉ mang tính răn đe, không thể ngăn chặn hoàn toàn.
        // Người dùng có kinh nghiệm vẫn có thể xem được mã nguồn.
        
        // Vô hiệu hóa chuột phải một cách hiệu quả hơn
        window.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        // Vô hiệu hóa các phím tắt
        window.addEventListener('keydown', function (e) {
            // Chặn F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+Shift+J, Ctrl+U, Ctrl+S
            if (
                e.key === 'F12' || e.keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U') ||
                (e.ctrlKey && e.key === 'S')
            ) {
                e.preventDefault();
            }
        });
    </script>
</head>
<body>

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-lg flex flex-col" style="height: 80vh;">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 rounded-t-lg flex items-center justify-center relative">
            <!-- ĐÃ SỬA: Dùng object-contain để giữ đúng tỷ lệ logo -->
            <img src="logo.png" alt="Logo" class="object-contain h-12 mr-4">
            <h1 class="text-2xl font-semibold">WELCOME TO HHTIP AI Testing</h1>
        </header>

        <!-- Chat messages -->
        <div id="chatbox" class="flex-1 p-6 space-y-4 overflow-y-auto">
            <div class="flex justify-start">
                <div class="gemini-message message-bubble">
                    Xin chào! Bạn có thể đặt câu hỏi hoặc tải tệp (.pdf, .docx, .xlsx, .pptx) lên để tôi phân tích. Tôi không chịu trách nhiệm về các nội dung bạn tải lên cũng như việc đảm bảo an toàn an ninh thông tin, dữ liệu mà bạn trao đổi/gửi tôi.
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden p-4 text-center">
            <div class="loader"></div>
            <p class="text-sm text-gray-500">Chat bot đang suy nghĩ...</p>
        </div>
        
        <!-- File Status -->
        <div id="fileStatus" class="p-2 text-center text-sm text-gray-600 border-t border-gray-200 bg-gray-50 hidden"></div>


        <!-- Input area -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
            <div class="flex items-center space-x-3">
                <!-- File Upload Button -->
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.xlsx,.xls,.pptx">
                <button id="uploadButton" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                    Tải tệp
                </button>
                <input type="text" id="userInput" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Nhập câu hỏi của bạn...">
                <button id="sendButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150">
                    Gửi
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');

        // State
        let chatHistory = [];
        let uploadedFileContent = null; // Store extracted text from the file

        // --- File Handling Logic ---

        // Setup PDF.js worker
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.102/pdf.worker.min.js`;
        }

        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            setFileStatus(`Đang xử lý tệp: ${file.name}...`, true);
            uploadedFileContent = null; // Reset previous content

            try {
                const arrayBuffer = await file.arrayBuffer();
                let text = '';
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.pdf')) {
                    text = await extractTextFromPdf(arrayBuffer);
                } else if (fileName.endsWith('.docx')) {
                    text = await extractTextFromDocx(arrayBuffer);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    text = await extractTextFromXlsx(arrayBuffer);
                } else if (fileName.endsWith('.pptx')) {
                    text = await extractTextFromPptx(arrayBuffer);
                } else {
                    throw new Error('Định dạng tệp không được hỗ trợ.');
                }
                uploadedFileContent = text;
                setFileStatus(`Đã tải lên: ${file.name}. Bây giờ hãy đặt câu hỏi về nội dung tệp.`, false);
            } catch (error) {
                console.error('File processing error:', error);
                setFileStatus(`Lỗi xử lý tệp: ${error.message}`, false);
                uploadedFileContent = null;
            } finally {
                fileInput.value = ''; // Allow re-uploading the same file
            }
        }

        function setFileStatus(message, showLoading) {
            fileStatus.textContent = message;
            fileStatus.classList.remove('hidden');
        }
        
        async function extractTextFromPdf(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let allText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                allText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return allText;
        }

        async function extractTextFromDocx(arrayBuffer) {
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }
        
        async function extractTextFromXlsx(arrayBuffer) {
            const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
            let allText = '';
            workbook.SheetNames.forEach(sheetName => {
                allText += `Sheet: ${sheetName}\n`;
                const worksheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_csv(worksheet);
                allText += data + '\n\n';
            });
            return allText;
        }
        
        async function extractTextFromPptx(arrayBuffer) {
            if (typeof JSZip === 'undefined') {
                throw new Error('Thư viện JSZip chưa được tải.');
            }
            const zip = await JSZip.loadAsync(arrayBuffer);
            const slideFiles = Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/slide') && name.endsWith('.xml'));
            let allText = '';
            
            const slidePromises = slideFiles.map(fileName => zip.file(fileName).async('string'));
            const slideContents = await Promise.all(slidePromises);

            for (const slideContent of slideContents) {
                const textNodes = slideContent.match(/<a:t>.*?<\/a:t>/g) || [];
                const slideText = textNodes.map(node => node.replace(/<a:t>(.*?)<\/a:t>/, '$1')).join(' ');
                allText += slideText + '\n';
            }
            return allText;
        }


        // --- Chat Logic ---
        
        function addMessage(text, type) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            
            messageBubble.textContent = text;
            
            if (type === 'user') {
                messageWrapper.classList.add('flex', 'justify-end');
                messageBubble.classList.add('message-bubble', 'user-message');
            } else if (type === 'gemini') {
                messageWrapper.classList.add('flex', 'justify-start');
                messageBubble.classList.add('message-bubble', 'gemini-message');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                messageBubble.textContent = tempDiv.textContent || tempDiv.innerText || "";
            } else { // 'system'
                messageBubble.classList.add('system-message', 'w-full');
            }

            messageWrapper.appendChild(messageBubble);
            chatbox.appendChild(messageWrapper);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        async function sendMessage() {
            let userMessage = userInput.value.trim();
            if (userMessage === '' && !uploadedFileContent) return; 
            if (userMessage === '' && uploadedFileContent) {
                userMessage = "Tóm tắt hoặc phân tích nội dung của tệp này.";
            }
            
            addMessage(userMessage, 'user');
            userInput.value = '';
            loadingIndicator.classList.remove('hidden');

            let promptToSend = userMessage;

            if (uploadedFileContent) {
                promptToSend = `Dựa trên nội dung của tài liệu sau:\n\n--- TÀI LIỆU ---\n${uploadedFileContent}\n--- KẾT THÚC TÀI LIỆU ---\n\nHãy trả lời câu hỏi sau: "${userMessage}"`;
                addMessage(`Đã sử dụng nội dung từ tệp để trả lời. Để hỏi về một tệp khác, vui lòng tải tệp mới lên.`, 'system');
                uploadedFileContent = null;
                fileStatus.classList.add('hidden'); 
            }

            chatHistory.push({ role: "user", parts: [{ text: promptToSend }] });

            try {
                const payload = {
                    contents: chatHistory,
                };

                const apiKey = "AIzaSyANk-Al0h0ts_EKhOcrV1PhnOIrEIcxBLg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Lỗi kết nối API');
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts) {
                    const geminiResponse = result.candidates[0].content.parts[0].text;
                    addMessage(geminiResponse, 'gemini');
                    chatHistory.push({ role: "model", parts: [{ text: geminiResponse }] });
                } else {
                    addMessage('Xin lỗi, tôi không nhận được phản hồi hợp lệ từ Chat BOT.', 'gemini');
                }

            } catch (error) {
                console.error('Lỗi khi gửi yêu cầu:', error);
                addMessage(`Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại.`, 'gemini');
                chatHistory.pop(); 
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
    </script>
</body>
</html>
